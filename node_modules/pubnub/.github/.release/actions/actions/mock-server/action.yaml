---
name: Contracts mock server
description: Mock server which is used during contract testing.
author: PubNub
inputs:
  token:
    description: GitHub access token with extended permissions.
    required: true
  features-path:
    description: Location to which cloned features should be copied.
    required: false
runs:
  using: "composite"
  steps:
    - name: Get npm cache directory
      id: npm-cache-dir
      shell: bash
      run: |
        echo "::set-output name=dir::$(npm config get cache)"
    - name: Process npm modules cache
      uses: actions/cache@v2
      with:
        path: ${{ steps.npm-cache-dir.outputs.dir }}
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-
    - name: Checkout SDK specifications
      uses: actions/checkout@v2
      with:
        repository: pubnub/sdk-specifications
        path: sdk-specifications
        token: ${{ inputs.token }}
    - name: Copy feature files
      shell: bash
      run: |
        echo "::group::Copy feature files"
        WORKSPACE_PATH="$(echo "${{ github.workspace }}" | tr '\\' '/')"
        if [[ -n "${{ inputs.features-path }}" ]]; then
          echo "::debug::Copy from '${{ github.workspace }}\sdk-specifications\features' to ${{ github.workspace }}\\${{ inputs.features-path }}"
          ! [[ -d "$WORKSPACE_PATH/${{ inputs.features-path }}" ]] && mkdir -p "$WORKSPACE_PATH/${{ inputs.features-path }}"
          cp -a "$WORKSPACE_PATH/sdk-specifications/features/". "$WORKSPACE_PATH/${{ inputs.features-path }}/"
        else
          echo "::debug::Feature files handled manually."
        fi
        echo "::endgroup::"
    - name: Checkout service contract mock server
      uses: actions/checkout@v2
      with:
        repository: pubnub/service-contract-mock
        path: service-contract-mock
        token: ${{ inputs.token }}
    - name: Prepare service contract mock server
      shell: bash
      run: |
        WORKSPACE_PATH="$(echo "${{ github.workspace }}" | tr '\\' '/')"
        echo -en "\033[96mInstalling service contract mock server dependencies...\033[0m "
        if ! npm_out="$(npm --prefix service-contract-mock ci 2>&1)"; then
          echo -e "\n\033[1;31mfile=action.yml,line=66,col=25::Dependency install failed: ${npm_out}\033[0m"
          exit 1
        fi
        if ! npm_out="$(npm install --no-save wait-port 2>&1)"; then
          echo -e "\n\033[1;31mfile=action.yml,line=71,col=25::Dependency install failed: ${npm_out}\033[0m"
          exit 1
        fi
        echo -e "\033[32mdone\033[0m"
        echo -en "\033[96mPreparing contracts for server build...\033[0m "
        if ! rm_out="$(rm -rf "$WORKSPACE_PATH/service-contract-mock/src/contracts" 2>&1)"; then
          echo -e "\n\033[1;31mfile=action.yml,line=77,col=26::Contracts copy error: ${rm_out}\033[0m"
          exit 1
        fi
        if ! cp_out="$(cp -r "$WORKSPACE_PATH/sdk-specifications/contracts" "$WORKSPACE_PATH/service-contract-mock/src/contracts" 2>&1)"; then
          echo -e "\n\033[1;31mfile=action.yml,line=81,col=26::Contracts copy error: ${cp_out}\033[0m"
          exit 1
        fi
        if ! npm_out="$(npm --prefix service-contract-mock run fix-imports 2>&1)"; then
          echo -e "\033[1;31mfile=action.yml,line=96,col=25::Contracts import fix failed: ${npm_out}\033[0m"
          exit 1
        fi
        echo -e "\033[32mdone\033[0m"
#          TODO: Uncomment when "inputs.token" will have permissions to access "pubnub/openapi" repository.
#          echo -en "\033[96mPreparing OpenAPI specifications for server build...\033[0m "
#          if ! npm_out="$(npm --prefix service-contract-mock run refresh-openapi 2>&1)"; then
#            echo "::error file=action.yml,line=66,col=25::OpenAPI specifications copy error: ${npm_out}"
#            exit 1
#          fi
#          echo -e "\033[32mdone\033[0m"
    - name: Run mock contract server in background
      shell: bash
      run: |
        WORKSPACE_PATH="$(echo "${{ github.workspace }}" | tr '\\' '/')"
        echo -e "\033[96mBuilding and starting service contract mock server...\033[0m "
        npm start --prefix service-contract-mock consumer &
        $WORKSPACE_PATH/node_modules/.bin/wait-port http://localhost:8090/expect
